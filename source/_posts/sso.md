---
title: 单点登录 sso
date: 2020-06-28 15:39:52
tags:
    - sso
cover: https://cdn.pixabay.com/photo/2020/06/20/01/24/frog-5319326__480.jpg
---

随着公司业务越来越复杂，单系统应用可能不再满足于我们的需求， 就出现了多系统的应用群， 那么也就出现了登录问题。

当面对众多的系统时，如果让用户一个一个的登录，注销， 这样显然是有些不太友好。毕竟系统由单系统发展成多系统组成的应用群，复杂性应该由系统内部承担，而不是用户。无论web系统内部多么复杂，对用户而言，都是一个统一的整体，也就是说，用户访问web系统的整个应用群与访问单个系统一样，登录/注销只要一次就够了。

因此，我们需要一种全新的登录方式来实现多系统应用群的登录，这就是单点登录

在介绍单点登录之前， 先来回顾一下现有的登录机制

### 一. 单系统登录机制

web应用使用http作为通信协议。 http是无状态协议，对于浏览器的每次请求，服务器都是独立处理的，与前后的请求都是没有关联的。 这也就意味着，服务器单从网络连接上无从知道客户身份，也就无法分辨合法请求与非法请求。

要想服务端能够识别用户，给每个用户颁发一个通行证， 每次访问时， 都在请求中带上通行证，这样就可以了。 最常见的方式就是cookie

Cookie 是客户端保存用户信息的一种机制，保存在客户机硬盘上， 可以由服务器响应报文Set-Cookie的首部字段信息或者客户端 document.cookie来设置，并随着每次请求发送到服务器， 子域名可以获取父级域名 Cookie。

我们可以通过下图简单梳理一下单系统登录的流程

![](https://user-gold-cdn.xitu.io/2020/1/5/16f74f3ed7b34a97?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

- 用户访问页面， 服务端验证是否登录， 若未登录， 重定向到登录页面
- 用户在登录页面，输入用户名，密码，向服务端发起登录请求
- 服务端收到请求后， 进行验证， 验证成功，设置cookie
- 用户再次访问页面时， 在请求头中携带cookie
- 服务端接收cookie，进行验证， 用户成功登录， 成功返回数据

### 二.  多系统复杂登录

单系统登录的解决方案并不能应用于多系统应用群， 因为单系统登录解决方案的核心是cookie，cookie携带会话id在浏览器与服务器之间维护会话状态。但cookie是有限制的，这个限制就是cookie的域（通常对应网站的域名），浏览器发送http请求时会自动携带与该域匹配的cookie，而不是所有cookie。

cookie不可跨域使用， 那如果我们将所有的子系统的域名统一在一个顶级域名下， 如系统a 为 'a.baidu.com', 系统b 为'b.baidu.com'，然后把cookie种在baidu.com 之下， 就可以实现多系统的登录了。

这种同域名共享cookie的方式， 可以解决多系统登录的问题， 但是当主域名不同的时候，就没有办法通过这种方式解决了。 因此， 我们需要一种全新的登录方式， 就是单点登录。

### 三. 单点登录

单点登录（Single Sign On），简称为 SSO，是目前比较流行的多系统登录的解决方案之一。SSO的定义是在多个应用系统中，用户只需要登录一次就可以访问所有相互信任的应用系统。

SSO一般都需要一个独立的认证中心（passport），子系统的登录均得通过passport，子系统本身将不参与登录操作，当一个系统成功登录以后，passport将会颁发一个令牌给各个子系统，子系统可以拿着令牌会获取各自的受保护资源，为了减少频繁认证，子系统在被passport授权以后，该子系统会建立一个局部会话，在一定时间内该子系统可以无需再次向passport发起认证。


#### 单点登录流程

##### 1. 登录

![](https://images2015.cnblogs.com/blog/797930/201612/797930-20161203152650974-276822362.png)

- 用户访问系统1的受保护资源，系统1发现用户未登录，跳转至sso认证中心，并将自己的地址作为参数
- sso认证中心发现用户未登录，将用户引导至登录页面
- 用户输入用户名密码提交登录申请
- sso认证中心校验用户信息，创建用户与sso认证中心之间的会话，称为全局会话，同时创建授权令牌
- sso认证中心带着令牌跳转会最初的请求地址（系统1）
- 系统1拿到令牌，去sso认证中心校验令牌是否有效
- sso认证中心校验令牌，返回有效，注册系统1
- 系统1使用该令牌创建与用户的会话，称为局部会话，返回受保护资源
- 用户访问系统2的受保护资源
- 系统2发现用户未登录，跳转至sso认证中心，并将自己的地址作为参数
- sso认证中心发现用户已登录，跳转回系统2的地址，并附上令牌
- 系统2拿到令牌，去sso认证中心校验令牌是否有效
- sso认证中心校验令牌，返回有效，注册系统2
- 系统2使用该令牌创建与用户的局部会话，返回受保护资源


用户登录成功之后，会与sso认证中心及各个子系统建立会话，用户与sso认证中心建立的会话称为全局会话，用户与各个子系统建立的会话称为局部会话，局部会话建立之后，用户访问子系统受保护资源将不再通过sso认证中心，全局会话与局部会话有如下约束关系

1. 局部会话存在，全局会话一定存在
2. 全局会话存在，局部会话不一定存在
3. 全局会话销毁，局部会话必须销毁


##### 2. 注销

sso认证中心一直监听全局会话的状态，一旦全局会话销毁，监听器将通知所有注册系统执行注销操作

![](https://images2015.cnblogs.com/blog/797930/201611/797930-20161129155243068-1378377736.png)

- 用户向系统1发起注销请求
- 系统1根据用户与系统1建立的会话id拿到令牌，向sso认证中心发起注销请求
- sso认证中心校验令牌有效，销毁全局会话，同时取出所有用此令牌注册的系统地址
- sso认证中心向所有注册系统发起注销请求
- 各注册系统接收sso认证中心的注销请求，销毁局部会话
- sso认证中心引导用户至登录页面

#### 单点登录优点

- 方便用户   用户使用系统时， 登录一个系统，即可在所有子系统同时登录， 省时省力
- 方便管理员   多个系统使用同一套用户名密码， 方便用户记忆， 也方便管理员管理
- 简化开发流程   若需要扩展新系统， 只需接入sso即可， 不需要重新开发新的登录功能

#### 参考文章：

1. [单点登录原理与简单实现][1]


[1]: https://www.cnblogs.com/ywlaker/p/6113927.html